<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:task="http://www.springframework.org/schema/task"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-5.2.xsd
        http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task-4.0.xsd">

    <!-- BEANS-->
    <bean id="printService" class="us.vicentini.integration.service.PrintService"/>
    <bean id="numericPrintService" class="us.vicentini.integration.service.NumericPrintService"/>
    <bean id="uppercasePrintService" class="us.vicentini.integration.service.UppercasePrintService"/>
    <bean id="oddEvenComparator" class="us.vicentini.integration.runner.channel.PriorityQueueChannelAppRunner.CustomMessageComparator"/>
    <bean id="myInterceptor" class="us.vicentini.integration.CustomChannelInterceptor"/>

    <!-- Direct Channel -->
    <int:channel id="inputChannel">
        <int:dispatcher failover="true"/>
    </int:channel>
    <int:gateway service-interface="us.vicentini.integration.PrinterGateway"
                 default-request-channel="inputChannel"/>

    <int:service-activator order="1" ref="printService" method="printMessage" input-channel="inputChannel"/>
    <int:service-activator order="2" ref="uppercasePrintService" method="printMessage" input-channel="inputChannel"/>

    <!-- Queue Channel -->
    <int:channel id="queueChannel">
        <int:queue capacity="10"/>
    </int:channel>
    <int:service-activator ref="printService" method="printMessageWithMessageNumber" input-channel="queueChannel">
        <int:poller fixed-rate="1" time-unit="SECONDS" max-messages-per-poll="2"/>
    </int:service-activator>
    <int:gateway service-interface="us.vicentini.integration.PrinterGateway" id="queuePrinterGateway"
                 default-request-channel="queueChannel"/>

    <!-- Priority Queue Channel -->
    <int:channel id="priorityChannel">
        <int:priority-queue capacity="10" comparator="oddEvenComparator"/>
    </int:channel>
    <int:service-activator ref="printService" method="printMessageWithMessageNumber" input-channel="priorityChannel">
        <int:poller fixed-rate="1" time-unit="SECONDS" max-messages-per-poll="2"/>
    </int:service-activator>
    <int:gateway service-interface="us.vicentini.integration.PrinterGateway" id="priorityPrinterGateway"
                 default-request-channel="priorityChannel"/>

    <!-- Publish Subscribe Channel -->
    <task:executor id="pubSubExecutor" pool-size="5"/>
    <int:publish-subscribe-channel id="pubSubChannel" task-executor="pubSubExecutor"/>
    <int:gateway id="pubSubPrinterGateway" service-interface="us.vicentini.integration.PrinterGateway"
                 default-request-channel="pubSubChannel"/>
    <int:service-activator order="1" ref="printService" method="printMessage" input-channel="pubSubChannel"/>
    <int:service-activator order="2" ref="uppercasePrintService" method="printMessage" input-channel="pubSubChannel"/>

    <!-- Messaging Bridge -->
    <int:gateway id="bridgePrinterGateway" service-interface="us.vicentini.integration.PrinterGateway"
                 default-request-channel="pollableChannel"/>
    <int:channel id="pollableChannel">
        <int:queue capacity="10"/>
        <int:interceptors>
            <int:ref bean="myInterceptor"/>
        </int:interceptors>
    </int:channel>
    <int:bridge input-channel="pollableChannel" output-channel="inputChannel">
        <int:poller fixed-delay="5" time-unit="SECONDS" max-messages-per-poll="2"/>
    </int:bridge>

    <!-- Payload Type Router S05L30-->
    <int:channel id="payloadRouterChannel">
        <int:dispatcher failover="true"/>
    </int:channel>
    <int:gateway id="payloadRouterGateway" service-interface="us.vicentini.integration.PrinterGateway"
                 default-request-channel="payloadRouterChannel"/>

    <int:payload-type-router input-channel="payloadRouterChannel">
        <int:mapping type="java.lang.Integer" channel="intChannel"/>
        <int:mapping type="java.lang.String" channel="stringChannel"/>
    </int:payload-type-router>
    <int:service-activator order="1" ref="printService" method="printMessage" input-channel="stringChannel"/>
    <int:service-activator order="2" ref="numericPrintService" method="printMessage" input-channel="intChannel"/>

</beans>
